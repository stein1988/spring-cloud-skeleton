# Easy-Query 配置指南

## 1. Maven 依赖配置

### 1.1 父项目依赖管理

在父项目的 `pom.xml` 文件中，添加 Easy-Query 相关依赖的版本管理：

```xml
<properties>
    <easy-query.version>3.1.78</easy-query.version>
    <HikariCP.verison>7.0.2</HikariCP.verison>
    <postgresql.version>42.7.9</postgresql.version>
</properties>

<dependencyManagement>
    <dependencies>
        <!-- 数据库连接池 -->
        <dependency>
            <groupId>com.zaxxer</groupId>
            <artifactId>HikariCP</artifactId>
            <version>${HikariCP.verison}</version>
        </dependency>

        <!-- postgresql驱动-->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <version>${postgresql.version}</version>
        </dependency>

        <!-- easy-query配合solon框架必须 -->
        <dependency>
            <groupId>com.easy-query</groupId>
            <artifactId>sql-solon-plugin</artifactId>
            <version>${easy-query.version}</version>
        </dependency>
        <!-- 如果您使用EasyEntityQuery那么需要引入该APT引用 -->
        <dependency>
            <groupId>com.easy-query</groupId>
            <artifactId>sql-processor</artifactId>
            <version>${easy-query.version}</version>
        </dependency>
        <!-- easy-query的数据库支持 -->
        <dependency>
            <groupId>com.easy-query</groupId>
            <artifactId>sql-pgsql</artifactId>
            <version>${easy-query.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### 1.2 子项目依赖

在子项目的 `pom.xml` 文件中，添加具体的依赖：

```xml
<dependencies>
    <!-- 数据库连接池 -->
    <dependency>
        <groupId>com.zaxxer</groupId>
        <artifactId>HikariCP</artifactId>
    </dependency>

    <!-- postgresql驱动-->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
    </dependency>

    <!-- easy-query配合solon框架必须 -->
    <dependency>
        <groupId>com.easy-query</groupId>
        <artifactId>sql-solon-plugin</artifactId>
    </dependency>
    <!-- 如果您使用EasyEntityQuery那么需要引入该APT引用 -->
    <dependency>
        <groupId>com.easy-query</groupId>
        <artifactId>sql-processor</artifactId>
    </dependency>
    <!-- easy-query的数据库支持 -->
    <dependency>
        <groupId>com.easy-query</groupId>
        <artifactId>sql-pgsql</artifactId>
    </dependency>
</dependencies>
```

### 1.3 编译配置

在父项目的 `pom.xml` 文件中，添加编译配置，确保 `sql-processor` 注解处理器能够正常工作：

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <annotationProcessorPaths>
                    <path>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok</artifactId>
                    </path>
                    <path>
                        <groupId>com.easy-query</groupId>
                        <artifactId>sql-processor</artifactId>
                        <version>${easy-query.version}</version>
                    </path>
                </annotationProcessorPaths>
            </configuration>
        </plugin>
    </plugins>
</build>
```

## 2. IDEA 插件

为了更好地使用 Easy-Query，推荐安装以下 IDEA 插件：

**Easy-Query Assistant**：Easy-Query 官方提供的 IDEA 插件，功能强大，能显著提高开发效率。参考[https://www.easy-query.com/easy-query-doc/plugin/](https://www.easy-query.com/easy-query-doc/plugin/)

### 主要功能
- 无需构建项目，自动感知，刷新 Maven、Gradle
- 直接生成代理类并添加接口
- SQL 日志批量生成无占位可直接运行的 SQL
- 根据表生成对应的实体（支持自定义模板导出导入）
- 查询时提示表别名
- 查询时提示更直观的关系运算符
- DTO 构建展示更加清晰的关系树结构
- 图形化构建 Navigate 关系
- DTO 类对于 entity 的属性快速提示
- 修改的 DTO 文件内容
- MyBatis-Plus 转 Easy-Query 注解

### 支持的 IDEA 版本
- IntelliJ IDEA Ultimate：插件 0.0.95<= 支持 IDEA 2022.2.5+；插件 0.0.96+ 支持 IDEA 2023.1.7+
- IDEA 社区版：可以进入 QQ 群文件下载或者联系群主获取

### 注意事项
- **强烈推荐使用 @EntityProxy**，不推荐使用 @EntityFileProxy
- 如果您使用的是非旗舰版 IDEA，可能无法使用当前插件，可进群联系作者获取社区版本支持的插件
- 版本升级时，如果使用 @EntityProxy，只需升级对应的框架版本和插件版本然后重新 clean 即可；如果使用 @EntityFileProxy，升级完框架和插件版本后需要重新调用插件的 AutoCompile 让生成的代理文件重新生成一遍
- DTO 或 VO 头部添加 @link 可以让插件连接到对应的实体，然后检测是否存在漏写字段等相关信息。注意 {@link entity} 需要写到注释头最前面，在这个前面不要加其他 @

### 插件地址
- 源码：[https://github.com/xuejmnet/easy-query-plugin](https://github.com/xuejmnet/easy-query-plugin)

## 3. 数据库参数配置

在 `app.yml` 文件中，配置数据库连接参数：

```yaml
solon.dataSources:
  db_master!:
    class: "com.zaxxer.hikari.HikariDataSource" #数据源类
    # PostgreSQL JDBC URL（注意格式：jdbc:postgresql://地址:端口/库名）
    jdbcUrl: jdbc:postgresql://192.168.9.230:5432/solon_demo?useUnicode=true&characterEncoding=utf8&ssl=false
    # 驱动类名（PostgreSQL 42.x 版本可省略，Solon 会自动识别）
    driverClassName: org.postgresql.Driver
    # 数据库账号密码
    username: solon
    password: solon@dev_2026
    # HikariCP 连接池配置（Solon 原生支持，参数与 HikariCP 一致）
    hikari:
      maximum-pool-size: 10        # 最大连接数（根据业务调整，建议 5-20）
      minimum-idle: 2              # 最小空闲连接
      idle-timeout: 300000         # 空闲连接超时（5分钟，单位毫秒）
      connection-timeout: 30000    # 连接获取超时（3秒）
      keepalive-time: 60000        # 连接心跳检测（1分钟，PostgreSQL 推荐开启）
      max-lifetime: 1800000        # 连接最大生命周期（30分钟）
      # 连接有效性检测（PostgreSQL 推荐用 select 1）
      validation-query: select 1
      validation-query-timeout: 5000
      test-while-idle: true        # 空闲时检测连接有效性
      test-on-borrow: false        # 借用连接时不检测（提升性能，靠 idle 检测即可

# 配置数据源对应的 easy-query 信息（要与 DataSource bean 的名字对上）
easy-query.db_master:
  name-conversion: underlined
  database: pgsql
  print-sql: true
  delete-throw: true
```

## 4. DataSource 的注入配置

### 4.1 实体类定义

使用 Easy-Query 的注解定义实体类：

```java
package com.lonbon.cloud.demo;

import com.easy.query.core.annotation.Column;
import com.easy.query.core.annotation.EntityProxy;
import com.easy.query.core.annotation.Table;
import com.easy.query.core.proxy.ProxyEntityAvailable;
import com.lonbon.cloud.demo.proxy.TopicProxy;
import lombok.Data;

@Data
@Table("t_topic")
@EntityProxy
public class Topic implements ProxyEntityAvailable<Topic , TopicProxy> {

    @Column(primaryKey = true)
    private String id;
    private Integer stars;
    private String title;
}
```

### 4.2 注入 EasyEntityQuery

在控制器或服务中，使用 `@Db` 注解注入 `EasyEntityQuery` 实例：

```java
package com.lonbon.cloud.demo;

import com.easy.query.api.proxy.client.EasyEntityQuery;
import com.easy.query.solon.annotation.Db;
import org.noear.solon.annotation.Controller;
import org.noear.solon.annotation.Mapping;
import org.noear.solon.annotation.Param;

import java.util.List;

@Controller
public class EasyQueryController {

    @Db("db_master")//注意这边使用sql-solon-plugin包下的Db注解
    private EasyEntityQuery easyEntityQuery;

    @Mapping("/query")
    public List<Topic> query(@Param(defaultValue = "world") String name) {
        return easyEntityQuery.queryable(Topic.class).toList();
    }
}
```

## 5. 搭建基本的 Solon+Easy-Query 应用步骤

### 步骤 1：创建 Solon 项目

使用 Maven 或 Gradle 创建一个 Solon 项目。

### 步骤 2：添加依赖

按照本文档第 1 节的配置，添加 Easy-Query 相关依赖。

### 步骤 3：配置数据库连接

在 `app.yml` 文件中，配置数据库连接参数，参考本文档第 3 节。

### 步骤 4：定义实体类

使用 Easy-Query 的注解定义实体类，参考本文档第 4.1 节。

### 步骤 5：注入 EasyEntityQuery

在控制器或服务中，使用 `@Db` 注解注入 `EasyEntityQuery` 实例，参考本文档第 4.2 节。

### 步骤 6：编写数据库操作代码

使用 `EasyEntityQuery` 实例进行数据库操作，例如：

```java
// 查询所有数据
List<Topic> topics = easyEntityQuery.queryable(Topic.class).toList();

// 根据条件查询
List<Topic> topics = easyEntityQuery.queryable(Topic.class)
    .where(o -> o.title().eq("Hello"))
    .toList();

// 插入数据
Topic topic = new Topic();
topic.setId("1");
topic.setTitle("Hello");
topic.setStars(5);
easyEntityQuery.insertable(topic).execute();

// 更新数据
topic.setTitle("Hello World");
easyEntityQuery.updatable(topic).execute();

// 删除数据
easyEntityQuery.deletable(topic).execute();
```

### 步骤 7：启动应用

启动 Solon 应用，测试数据库操作是否正常。

## 6. 注意事项

1. **注解包路径**：使用 `@Db` 注解时，要确保使用的是 `com.easy.query.solon.annotation.Db` 包下的注解，而不是其他包下的注解。

2. **实体代理**：如果使用了 `@EntityProxy` 注解，需要确保 IDE 能够正确生成代理类。如果代理类没有生成，可以尝试重新编译项目。

3. **数据库驱动**：根据使用的数据库类型，添加对应的数据库驱动依赖，例如 PostgreSQL、MySQL 等。

4. **连接池配置**：根据实际业务需求，调整连接池的配置参数，以获得最佳性能。

5. **SQL 打印**：在开发环境中，可以设置 `print-sql: true` 来打印生成的 SQL 语句，方便调试。在生产环境中，建议设置为 `false` 以提高性能。