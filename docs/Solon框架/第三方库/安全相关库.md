# 安全相关库

## 4.1 Spring Security

Spring Security 是一个功能强大的安全框架，提供了认证和授权功能。

### 4.1.1 添加依赖

```xml
<dependency>
    <groupId>org.noear</groupId>
    <artifactId>solon.extend.springsecurity</artifactId>
    <version>2.7.6</version>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-core</artifactId>
    <version>5.6.7</version>
</dependency>
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-web</artifactId>
    <version>5.6.7</version>
</dependency>
```

### 4.1.2 配置 Spring Security

```java
import org.noear.solon.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
                .and()
            .formLogin()
                .loginPage("/login")
                .permitAll()
                .and()
            .logout()
                .permitAll();
    }
}
```

### 4.1.3 实现用户详情服务

```java
import org.noear.solon.annotation.Component;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

@Component
public class UserDetailsServiceImpl implements UserDetailsService {
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // 从数据库中查询用户信息
        if (!"admin".equals(username)) {
            throw new UsernameNotFoundException("User not found");
        }
        
        // 创建用户详情对象
        return User.withUsername(username)
            .password("$2a$10$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW") // 密码: 123456
            .roles("ADMIN")
            .build();
    }
}
```

## 4.2 JWT

JWT (JSON Web Token) 是一种基于 JSON 的开放标准，用于在各方之间安全地传输信息。

### 4.2.1 添加依赖

```xml
<dependency>
    <groupId>org.noear</groupId>
    <artifactId>solon.extend.jwt</artifactId>
    <version>2.7.6</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>
```

### 4.2.2 配置 JWT

```java
import org.noear.solon.annotation.Configuration;
import org.noear.solon.annotation.Bean;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import java.security.Key;

@Configuration
public class JwtConfig {
    
    @Bean
    public Key jwtSecretKey() {
        return Keys.secretKeyFor(SignatureAlgorithm.HS256);
    }
    
    @Bean
    public String jwtIssuer() {
        return "solon-demo";
    }
}
```

### 4.2.3 生成和验证 JWT

```java
import org.noear.solon.annotation.Component;
import org.noear.solon.annotation.Inject;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.Claims;
import java.security.Key;
import java.util.Date;

@Component
public class JwtService {
    
    @Inject
    Key jwtSecretKey;
    
    @Inject("${jwt.issuer}")
    String jwtIssuer;
    
    private static final long EXPIRATION_TIME = 86400000; // 24 hours
    
    public String generateToken(String username) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + EXPIRATION_TIME);
        
        return Jwts.builder()
            .setSubject(username)
            .setIssuedAt(now)
            .setExpiration(expiryDate)
            .setIssuer(jwtIssuer)
            .signWith(jwtSecretKey)
            .compact();
    }
    
    public Claims validateToken(String token) {
        return Jwts.parserBuilder()
            .setSigningKey(jwtSecretKey)
            .build()
            .parseClaimsJws(token)
            .getBody();
    }
    
    public String getUsernameFromToken(String token) {
        Claims claims = validateToken(token);
        return claims.getSubject();
    }
}
```

### 4.2.4 创建 JWT 过滤器

```java
import org.noear.solon.annotation.Component;
import org.noear.solon.core.handle.Context;
import org.noear.solon.core.handle.Filter;
import org.noear.solon.core.handle.FilterChain;
import org.noear.solon.annotation.Inject;

@Component
public class JwtFilter implements Filter {
    
    @Inject
    JwtService jwtService;
    
    @Override
    public void doFilter(Context ctx, FilterChain chain) throws Throwable {
        String authorizationHeader = ctx.header("Authorization");
        
        if (authorizationHeader != null && authorizationHeader.startsWith("Bearer ")) {
            String token = authorizationHeader.substring(7);
            try {
                String username = jwtService.getUsernameFromToken(token);
                ctx.setAttribute("username", username);
            } catch (Exception e) {
                ctx.status(401);
                ctx.output("Invalid or expired token");
                return;
            }
        }
        
        chain.doFilter(ctx);
    }
}
```
