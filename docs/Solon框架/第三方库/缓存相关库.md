# 缓存相关库

## 2.1 Caffeine

Caffeine 是一个高性能的 Java 缓存库，提供了近乎最佳的命中率。

### 2.1.1 添加依赖

```xml
<dependency>
    <groupId>org.noear</groupId>
    <artifactId>solon.extend.caffeine</artifactId>
    <version>2.7.6</version>
</dependency>
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>3.0.6</version>
</dependency>
```

### 2.1.2 配置缓存

```java
import org.noear.solon.annotation.Configuration;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import org.noear.solon.annotation.Bean;

@Configuration
public class CacheConfig {
    
    @Bean
    public Cache<String, Object> localCache() {
        return Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(10, java.util.concurrent.TimeUnit.MINUTES)
            .build();
    }
}
```

### 2.1.3 使用缓存

```java
import org.noear.solon.annotation.Component;
import org.noear.solon.annotation.Inject;
import com.github.benmanes.caffeine.cache.Cache;

@Component
public class UserService {
    
    @Inject
    UserMapper userMapper;
    
    @Inject
    Cache<String, Object> localCache;
    
    public User getUserById(Long id) {
        String key = "user:" + id;
        return (User) localCache.get(key, k -> userMapper.selectById(id));
    }
    
    public void clearCache(Long id) {
        String key = "user:" + id;
        localCache.invalidate(key);
    }
}
```

## 2.2 Ehcache

Ehcache 是一个成熟的 Java 缓存框架，支持内存和磁盘存储。

### 2.2.1 添加依赖

```xml
<dependency>
    <groupId>org.noear</groupId>
    <artifactId>solon.extend.ehcache</artifactId>
    <version>2.7.6</version>
</dependency>
<dependency>
    <groupId>org.ehcache</groupId>
    <artifactId>ehcache</artifactId>
    <version>3.9.7</version>
</dependency>
```

### 2.2.2 配置缓存

创建 `ehcache.xml` 配置文件：

```xml
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.ehcache.org/v3"
        xsi:schemaLocation="http://www.ehcache.org/v3 http://www.ehcache.org/schema/ehcache-core-3.0.xsd">
    
    <cache alias="userCache">
        <key-type>java.lang.Long</key-type>
        <value-type>com.lonbon.demo.entity.User</value-type>
        <resources>
            <heap unit="entries">1000</heap>
            <offheap unit="MB">10</offheap>
        </resources>
    </cache>
</config>
```

### 2.2.3 使用缓存

```java
import org.noear.solon.annotation.Component;
import org.noear.solon.annotation.Inject;
import org.ehcache.Cache;
import org.ehcache.CacheManager;

@Component
public class UserService {
    
    @Inject
    UserMapper userMapper;
    
    @Inject
    CacheManager cacheManager;
    
    private Cache<Long, User> getUserCache() {
        return cacheManager.getCache("userCache", Long.class, User.class);
    }
    
    public User getUserById(Long id) {
        User user = getUserCache().get(id);
        if (user == null) {
            user = userMapper.selectById(id);
            if (user != null) {
                getUserCache().put(id, user);
            }
        }
        return user;
    }
    
    public void clearCache(Long id) {
        getUserCache().remove(id);
    }
}
```
