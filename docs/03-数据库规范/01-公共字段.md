# 公共字段规范

## 1. 概述

为了统一项目中所有实体类的字段结构和行为，我们定义了`BaseEntity`抽象类作为所有实体类的基类。该基类包含了一系列公共字段，用于记录实体的基本信息，如创建时间、更新时间、删除状态等。同时，通过easy-query框架的拦截器机制，实现了这些公共字段的自动管理，减少了重复代码，提高了开发效率。

## 2. BaseEntity公共字段

### 2.1 字段定义

```java
@Data
public abstract class BaseEntity implements Serializable, Cloneable {

    @Serial
    private static final long serialVersionUID = -1L;

    /**
     * 主键ID，使用UUIDv7算法
     */
    @Column(primaryKey = true, primaryKeyGenerator = UUIDPrimaryKeyGenerator.class)
    private UUID id;

    /**
     * 逻辑删除标志：是否删除，默认值为false
     * 逻辑删除时，还要处理deleteTime和deleteBy，所以使用自定义策略 {@link DefaultLogicDeleteStrategy}
     */
    @LogicDelete(strategy = LogicDeleteStrategyEnum.CUSTOM, strategyName = "DEFAULT_LOGIC_DELETE_STRATEGY")
    @UpdateIgnore
    private boolean isDeleted = false;

    /**
     * 删除时间，UTC时间戳
     */
    @UpdateIgnore
    private OffsetDateTime deleteTime;

    /**
     * 删除人ID
     */
    @UpdateIgnore
    private UUID deleteBy;

    /**
     * 创建时间，UTC时间戳
     */
    @UpdateIgnore
    private OffsetDateTime createTime;
    
    /**
     * 创建人ID
     */
    @UpdateIgnore
    private UUID createBy;
    
    /**
     * 更新时间，UTC时间戳
     */
    private OffsetDateTime updateTime;
    
    /**
     * 更新人ID
     */
    private UUID updateBy;

    /**
     * 版本号，用于乐观锁，默认值为0，每更新一次+1
     */
    private int versionId = 0;

    // 克隆方法实现...
}
```

### 2.2 字段详细说明

| 字段名 | 类型 | 含义 | 默认值 | 注解 | 作用 |
|-------|------|------|-------|------|------|
| id | UUID | 主键ID | 自动生成UUIDv7 | @Column(primaryKey = true, primaryKeyGenerator = UUIDPrimaryKeyGenerator.class) | 唯一标识实体记录 |
| isDeleted | boolean | 逻辑删除标志 | false | @LogicDelete(strategy = LogicDeleteStrategyEnum.CUSTOM, strategyName = "DEFAULT_LOGIC_DELETE_STRATEGY")<br>@UpdateIgnore | 标记记录是否被逻辑删除 |
| deleteTime | OffsetDateTime | 删除时间 | null | @UpdateIgnore | 记录逻辑删除的时间 |
| deleteBy | UUID | 删除人ID | null | @UpdateIgnore | 记录执行删除操作的用户ID |
| createTime | OffsetDateTime | 创建时间 | null | @UpdateIgnore | 记录实体创建的时间 |
| createBy | UUID | 创建人ID | null | @UpdateIgnore | 记录创建实体的用户ID |
| updateTime | OffsetDateTime | 更新时间 | null | - | 记录实体最后更新的时间 |
| updateBy | UUID | 更新人ID | null | - | 记录最后更新实体的用户ID |
| versionId | int | 版本号 | 0 | - | 用于乐观锁，防止并发更新冲突 |

**说明**：
- **UUID类型**：使用`java.util.UUID`类型作为主键，通过`UUIDPrimaryKeyGenerator`生成UUIDv7，确保全局唯一性和时间有序性
- **OffsetDateTime类型**：所有时间字段使用`OffsetDateTime`类型，存储带时区的UTC时间戳，确保跨时区一致性
- **@UpdateIgnore注解**：标记字段在更新操作时忽略，避免被自动更新覆盖
- **默认值**：部分字段设置了默认值，如`isDeleted`默认为false，`versionId`默认为0

## 3. easy-query框架拦截器与公共字段

### 3.1 DefaultEntityInterceptor

`DefaultEntityInterceptor`实现了easy-query的拦截器接口，用于自动处理实体的创建和更新时间：

```java
@Component
@AllArgsConstructor(onConstructor_ = @Autowired)
public class DefaultEntityInterceptor implements EntityInterceptor, UpdateSetInterceptor, UpdateEntityColumnInterceptor {

    @Override
    public String name() {
        return "DEFAULT_INTERCEPTOR";
    }

    @Override
    public boolean apply(@NonNull Class<?> entityClass) {
        return BaseEntity.class.isAssignableFrom(entityClass);
    }

    @Override
    public void configureInsert(Class<?> entityClass, EntityInsertExpressionBuilder entityInsertExpressionBuilder, Object entity) {
        BaseEntity baseEntity = (BaseEntity) entity;

        OffsetDateTime now = OffsetDateTime.now();

        if (baseEntity.getCreateTime() == null) {
            baseEntity.setCreateTime(now);
        }
        if (baseEntity.getCreateBy() == null) {
            // 可以在这里设置创建人ID
        }
        if (baseEntity.getUpdateTime() == null) {
            baseEntity.setUpdateTime(now);
        }
        if (baseEntity.getUpdateBy() == null) {
            // 可以在这里设置更新人ID
        }
    }

    @Override
    public void configureUpdate(Class<?> entityClass, EntityUpdateExpressionBuilder entityUpdateExpressionBuilder, Object entity) {
        BaseEntity baseEntity = (BaseEntity) entity;
        baseEntity.setUpdateTime(OffsetDateTime.now());
        // 可以在这里设置更新人ID
    }

    // 其他方法实现...
}
```

**功能说明**：
- **自动应用范围**：所有继承`BaseEntity`的实体类
- **insert操作**：自动设置`createTime`和`updateTime`为当前时间（如果为空）
- **update操作**：自动更新`updateTime`为当前时间
- **扩展点**：预留了设置`createBy`和`updateBy`的位置，可以集成用户认证系统获取当前用户ID

### 3.2 DefaultLogicDeleteStrategy

`DefaultLogicDeleteStrategy`实现了easy-query的逻辑删除策略接口，用于处理逻辑删除相关的字段：

```java
@Component
@RequiredArgsConstructor(onConstructor_ = @Autowired)
public class DefaultLogicDeleteStrategy extends AbstractLogicDeleteStrategy {
    @Override
    public String getStrategy() {
        return "DEFAULT_LOGIC_DELETE_STRATEGY";
    }

    @Override
    public Set<Class<?>> allowedPropertyTypes() {
        return Set.of(Boolean.class);
    }

    @Override
    protected SQLActionExpression1<WherePredicate<Object>> getPredicateFilterExpression(LogicDeleteBuilder builder, String propertyName) {
        return o->o.eq(propertyName, false);
    }

    @Override
    protected SQLActionExpression1<ColumnSetter<Object>> getDeletedSQLExpression(LogicDeleteBuilder builder, String propertyName) {
        return o->o.set(propertyName, true).set("deleteTime", OffsetDateTime.now());
    }
}
```

**功能说明**：
- **策略名称**：`DEFAULT_LOGIC_DELETE_STRATEGY`，与`BaseEntity`中`@LogicDelete`注解的`strategyName`对应
- **查询过滤器**：自动为查询操作添加`isDeleted = false`的条件，确保只查询未删除的记录
- **逻辑删除操作**：执行逻辑删除时，自动设置`isDeleted = true`和`deleteTime`为当前时间
- **扩展点**：预留了设置`deleteBy`的位置，可以集成用户认证系统获取当前用户ID

## 4. 工作流程

### 4.1 实体创建流程

1. 创建实体对象
2. 调用`save`方法保存实体
3. `UUIDPrimaryKeyGenerator`自动生成UUIDv7作为主键
4. `DefaultEntityInterceptor`自动设置`createTime`和`updateTime`为当前时间
5. 数据持久化到数据库

### 4.2 实体更新流程

1. 获取实体对象
2. 修改实体属性
3. 调用`update`方法更新实体
4. `DefaultEntityInterceptor`自动更新`updateTime`为当前时间
5. 数据持久化到数据库

### 4.3 实体删除流程

1. 获取实体对象
2. 调用`delete`方法删除实体
3. `DefaultLogicDeleteStrategy`自动执行逻辑删除：
   - 设置`isDeleted = true`
   - 设置`deleteTime`为当前时间
4. 数据持久化到数据库

### 4.4 实体查询流程

1. 调用查询方法
2. `DefaultLogicDeleteStrategy`自动添加查询过滤器：`isDeleted = false`
3. 执行数据库查询，只返回未删除的记录

## 5. 代码示例

### 5.1 实体类继承示例

```java
@Data
@Table("user")
public class User extends BaseEntity {
    private String username;
    private String email;
    private String password;
    // 其他业务字段...
}
```

### 5.2 保存实体示例

```java
User user = new User();
user.setUsername("admin");
user.setEmail("admin@example.com");
user.setPassword("encrypted_password");
// 无需手动设置id、createTime、updateTime等字段
easyQuery.insert(user).executeRows();
// 此时user对象已自动设置了id、createTime、updateTime等字段
```

### 5.3 更新实体示例

```java
User user = easyQuery.queryable(User.class).where(o -> o.eq("username", "admin")).firstOrNull();
if (user != null) {
    user.setEmail("new_admin@example.com");
    // 无需手动设置updateTime字段
    easyQuery.update(user).executeRows();
    // 此时user对象的updateTime已自动更新
}
```

### 5.4 删除实体示例

```java
User user = easyQuery.queryable(User.class).where(o -> o.eq("username", "admin")).firstOrNull();
if (user != null) {
    // 执行逻辑删除
    easyQuery.delete(user).executeRows();
    // 此时user对象的isDeleted已设置为true，deleteTime已设置为当前时间
}
```

### 5.5 查询实体示例

```java
// 自动过滤已删除的记录
List<User> users = easyQuery.queryable(User.class).where(o -> o.like("username", "a%")).toList();
// 返回的users列表中只包含isDeleted = false的记录
```

## 6. 配置与依赖

### 6.1 依赖配置

项目使用了以下关键依赖：

- **easy-query**：ORM框架，提供了拦截器和逻辑删除功能
- **uuid-creator**：用于生成UUIDv7
- **Spring Boot**：提供了依赖注入和组件管理

### 6.2 组件注册

所有拦截器和策略类都使用了`@Component`注解，确保被Spring Boot自动扫描和注册：

- `UUIDPrimaryKeyGenerator`：主键生成器
- `DefaultEntityInterceptor`：实体拦截器
- `DefaultLogicDeleteStrategy`：逻辑删除策略

## 7. 最佳实践

1. **统一继承BaseEntity**：所有实体类都应继承`BaseEntity`，确保字段结构一致
2. **避免手动设置公共字段**：公共字段由拦截器自动处理，避免手动设置导致的不一致
3. **集成用户认证系统**：根据实际项目情况，集成用户认证系统，实现`createBy`、`updateBy`和`deleteBy`的自动设置
4. **合理使用版本号**：利用`versionId`字段实现乐观锁，防止并发更新冲突
5. **注意时区处理**：所有时间字段使用`OffsetDateTime`类型，确保跨时区一致性

## 8. 参考链接

- [easy-query文档 - 对象设计](https://www.easy-query.com/easy-query-doc/practice/configuration/entity.html)
- [easy-query文档 - 自定义主键](https://www.easy-query.com/easy-query-doc/adv/auto-key.html)