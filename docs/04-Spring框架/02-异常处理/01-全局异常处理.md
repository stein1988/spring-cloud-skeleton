# 全局异常处理

## 概述

在 Spring Boot 应用开发中，完善的异常处理机制是构建健壮、可维护系统的关键要素。一个优秀的异常处理方案不仅能够统一错误响应格式、提供清晰的错误码体系，还能有效保护系统安全、支持监控告警，并为开发调试提供便利。本文档基于项目实践，详细介绍全局异常处理系统的设计和实现。

## 设计理念

### 模块化设计

异常处理系统采用模块化设计，将核心功能集中在 `module-base` 模块中，以便所有其他模块复用。这种设计有以下优势：

- **统一管理**：所有异常处理相关的核心类和配置都集中在 base 模块中，便于维护和更新
- **复用性强**：其他模块只需引入 `module-base` 依赖，即可使用完整的异常处理功能
- **一致性**：确保所有模块使用相同的异常处理机制，保持系统的一致性
- **依赖合理**：base 模块作为项目底层依赖，所有业务模块、common 模块都依赖 base，避免了依赖循环

### 分层异常体系

设计了分层的异常体系，从基础异常到具体业务异常，形成清晰的继承关系：

- **BaseBusinessException**：基础业务异常类，所有业务异常的父类
- **BaseTechException**：基础技术异常类，所有技术异常的父类
- **BusinessException**（common 模块）：业务异常，用于处理业务逻辑层面的异常
- **ParameterException**（common 模块）：参数异常，用于处理参数验证失败等情况

### 统一错误响应

使用 `ErrorResponse` 类作为统一的错误响应格式，确保所有异常都返回一致的错误响应结构：

```json
{
  "code": 40000,
  "message": "业务逻辑错误",
  "data": null
}
```

### 清晰的错误码体系

设计了清晰的错误码体系，遵循 REST 风格，使用 HTTP 状态码作为基础，扩展具体的错误类型：

- **系统错误 (500xx)**：如系统内部错误、数据库操作错误等
- **业务错误 (400xx)**：如业务逻辑错误、资源不存在等
- **参数错误 (400xx)**：如参数错误、缺少必要参数等
- **认证错误 (401xx)**：如未授权、无效的令牌等
- **授权错误 (403xx)**：如禁止访问、访问被拒绝等
- **请求错误 (404xx)**：如请求的资源不存在、请求方法不允许等

## 实现细节

### 核心组件

#### 1. 错误码定义

在 `ErrorCode` 枚举中定义了系统中使用的所有错误码：

```java
public enum ErrorCode {
    // 系统错误 (500xx)
    SYSTEM_ERROR(50000, "系统内部错误"),
    DATABASE_ERROR(50001, "数据库操作错误"),
    // 其他错误码...
}
```

#### 2. 基础异常类

- **BaseBusinessException**：基础业务异常类，包含错误码和错误消息
- **BaseTechException**：基础技术异常类，包含错误码和错误消息

#### 3. 统一响应相关

- **ErrorResponse**：统一错误响应类，用于返回标准化的错误响应格式
- **ResponseUtil**：响应工具类，用于快速构建异常响应

#### 4. 全局异常处理器

使用 `@RestControllerAdvice` 注解实现全局异常处理器，能够捕获和处理各种异常：

- **自定义异常**：处理 `BaseBusinessException`、`BaseTechException` 等自定义异常
- **参数验证异常**：处理 `MethodArgumentNotValidException`、`BindException` 等参数验证异常
- **系统异常**：处理 `Exception` 等系统异常

#### 5. 自动配置

在 `module-base` 模块中创建了 `BaseAutoConfiguration` 自动配置类，并通过 `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` 文件注册，确保异常处理器被正确扫描和加载。

### 工作流程

1. **异常抛出**：在业务逻辑中，当遇到异常情况时，抛出相应的自定义异常
2. **异常捕获**：全局异常处理器捕获抛出的异常
3. **异常处理**：根据异常类型，调用相应的处理方法
4. **响应生成**：生成统一格式的错误响应
5. **响应返回**：将错误响应返回给客户端

## 模块职责划分

### base 模块（核心异常处理）

**核心职责**：提供项目全局的异常处理核心能力，是整个异常处理系统的基础。

**包含内容**：
- `ErrorCode`：错误码定义
- `BaseBusinessException`：基础业务异常类
- `BaseTechException`：基础技术异常类
- `ErrorResponse`：统一错误响应类
- `ResponseUtil`：响应工具类
- `GlobalExceptionHandler`：全局异常处理器
- `BaseAutoConfiguration`：基础模块自动配置类

**依赖关系**：不依赖项目内任何模块，仅依赖第三方基础依赖（如 Spring Boot Starter）。

### common 模块（辅助异常处理）

**核心职责**：提供通用的异常处理辅助能力，是业务模块的辅助支撑。

**包含内容**：
- `BusinessException`：业务异常类，继承自 `BaseBusinessException`
- `ParameterException`：参数异常类，继承自 `BaseBusinessException`

**依赖关系**：依赖 base 模块，复用 base 的异常处理核心能力。

### 业务模块

**核心职责**：使用异常处理系统，处理具体的业务逻辑异常。

**使用方式**：
- 依赖 base 模块（必须）
- 可选择性依赖 common 模块（复用通用异常、辅助工具）
- 在业务逻辑中抛出相应的异常

## 使用方法

### 1. 引入依赖

在需要使用异常处理功能的模块中，添加对 `module-base` 的依赖：

```xml
<dependency>
    <groupId>com.lonbon.cloud</groupId>
    <artifactId>base</artifactId>
    <version>1.0</version>
</dependency>
```

如果需要使用 common 模块提供的通用异常，可以添加对 `module-common` 的依赖：

```xml
<dependency>
    <groupId>com.lonbon.cloud</groupId>
    <artifactId>common</artifactId>
    <version>1.0</version>
</dependency>
```

### 2. 抛出自定义异常

在业务逻辑中，当遇到异常情况时，抛出相应的自定义异常：

#### 抛出业务异常

```java
if (user == null) {
    throw new BusinessException(ErrorCode.RESOURCE_NOT_FOUND, "用户不存在");
}
```

#### 抛出参数异常

```java
if (StringUtils.isEmpty(username)) {
    throw new ParameterException(ErrorCode.MISSING_PARAMETER, "用户名不能为空");
}
```

### 3. 使用参数验证

使用 JSR-303/JSR-380 注解进行参数验证，当验证失败时，会自动抛出 `MethodArgumentNotValidException` 异常，被全局异常处理器捕获并处理：

```java
@GetMapping("/test/validation")
public Response<?> testValidation(
        @RequestParam @NotBlank(message = "名称不能为空") String name,
        @RequestParam @Min(value = 18, message = "年龄必须大于等于18") Integer age) {
    return Response.success("参数验证通过: " + name + ", " + age);
}
```

### 4. 处理系统异常

对于系统异常（如空指针异常、数据库异常等），无需手动捕获，会被全局异常处理器自动捕获并处理，返回统一的错误响应。

## 错误码体系

### 系统错误 (500xx)

| 错误码 | 错误消息 | 描述 |
|-------|---------|------|
| 50000 | 系统内部错误 | 通用系统错误 |
| 50001 | 数据库操作错误 | 数据库相关错误 |
| 50002 | 网络请求错误 | 网络相关错误 |
| 50003 | 服务不可用 | 服务暂时不可用 |

### 业务错误 (400xx)

| 错误码 | 错误消息 | 描述 |
|-------|---------|------|
| 40000 | 业务逻辑错误 | 通用业务错误 |
| 40001 | 资源不存在 | 请求的资源不存在 |
| 40002 | 资源已存在 | 要创建的资源已存在 |
| 40003 | 操作不允许 | 当前操作不被允许 |
| 40004 | 权限不足 | 用户权限不足 |

### 参数错误 (400xx)

| 错误码 | 错误消息 | 描述 |
|-------|---------|------|
| 40005 | 参数错误 | 通用参数错误 |
| 40006 | 缺少必要参数 | 缺少必需的参数 |
| 40007 | 参数值无效 | 参数值不符合要求 |
| 40008 | 参数长度过长 | 参数长度超过限制 |

### 认证错误 (401xx)

| 错误码 | 错误消息 | 描述 |
|-------|---------|------|
| 40100 | 未授权 | 未提供认证信息 |
| 40101 | 无效的令牌 | 认证令牌无效 |
| 40102 | 令牌已过期 | 认证令牌已过期 |
| 40103 | 需要登录 | 需要登录才能访问 |

### 授权错误 (403xx)

| 错误码 | 错误消息 | 描述 |
|-------|---------|------|
| 40300 | 禁止访问 | 禁止访问该资源 |
| 40301 | 访问被拒绝 | 访问请求被拒绝 |

### 请求错误 (404xx)

| 错误码 | 错误消息 | 描述 |
|-------|---------|------|
| 40400 | 请求的资源不存在 | 请求的 URL 不存在 |
| 40401 | 请求方法不允许 | 请求方法不被允许 |

### 其他错误

| 错误码 | 错误消息 | 描述 |
|-------|---------|------|
| 99999 | 未知错误 | 未知类型的错误 |

## 测试

### 测试控制器

项目中提供了 `ExceptionTestController` 类，用于测试各种异常情况的处理：

- **业务异常测试**：`/test/business-exception`
- **参数异常测试**：`/test/parameter-exception`
- **资源不存在测试**：`/test/not-found/{id}`
- **权限不足测试**：`/test/permission-denied`
- **参数验证测试**：`/test/validation`
- **系统异常测试**：`/test/system-exception`

### 测试示例

#### 测试业务异常

**请求**：
```
GET /test/business-exception
```

**响应**：
```json
{
  "code": 40000,
  "message": "测试业务异常",
  "data": null
}
```

#### 测试参数验证异常

**请求**：
```
GET /test/validation?name=&age=10
```

**响应**：
```json
{
  "code": 40005,
  "message": "名称不能为空, 年龄必须大于等于18",
  "data": null
}
```

#### 测试系统异常

**请求**：
```
GET /test/system-exception
```

**响应**：
```json
{
  "code": 50000,
  "message": "系统内部错误",
  "data": null
}
```

## 最佳实践

### 1. 异常类型选择

- **业务逻辑错误**：使用 `BusinessException`
- **参数验证错误**：使用 `ParameterException`
- **技术错误**：使用 `BaseTechException` 或其子类
- **系统内部错误**：无需手动抛出，由全局异常处理器自动捕获

### 2. 错误消息规范

- **清晰明确**：错误消息应清晰明确，便于用户理解
- **包含具体信息**：错误消息应包含具体的错误原因，如 "用户不存在: 123"
- **避免敏感信息**：错误消息不应包含敏感信息，如数据库表结构、内部实现细节等

### 3. 异常处理层级

- **控制器层**：不捕获异常，让异常向上抛出，由全局异常处理器处理
- **服务层**：只捕获需要特殊处理的异常，其他异常向上抛出
- **数据访问层**：捕获数据库相关异常，转换为 `BaseTechException` 后向上抛出

### 4. 日志记录

- **异常发生时**：记录异常信息，包括异常类型、消息、堆栈信息等
- **日志级别**：根据异常类型选择合适的日志级别，如业务异常使用 `warn`，系统异常使用 `error`
- **上下文信息**：在记录异常时，应包含相关的上下文信息，如请求参数、用户信息等

### 5. 监控告警

- **关键异常**：对关键业务异常和系统异常设置监控告警
- **告警阈值**：设置合理的告警阈值，避免告警风暴
- **告警方式**：根据异常严重程度选择合适的告警方式，如邮件、短信、微信等

## 代码结构

### base 模块

| 类名 | 描述 | 路径 |
|------|------|------|
| `ErrorCode` | 错误码定义 | `module-base/src/main/java/com/lonbon/cloud/base/exception/ErrorCode.java` |
| `BaseBusinessException` | 基础业务异常类 | `module-base/src/main/java/com/lonbon/cloud/base/exception/BaseBusinessException.java` |
| `BaseTechException` | 基础技术异常类 | `module-base/src/main/java/com/lonbon/cloud/base/exception/BaseTechException.java` |
| `ErrorResponse` | 统一错误响应类 | `module-base/src/main/java/com/lonbon/cloud/base/response/ErrorResponse.java` |
| `ResponseUtil` | 响应工具类 | `module-base/src/main/java/com/lonbon/cloud/base/response/ResponseUtil.java` |
| `GlobalExceptionHandler` | 全局异常处理器 | `module-base/src/main/java/com/lonbon/cloud/base/exception/GlobalExceptionHandler.java` |
| `BaseAutoConfiguration` | 基础模块自动配置类 | `module-base/src/main/java/com/lonbon/cloud/base/config/BaseAutoConfiguration.java` |

### common 模块

| 类名 | 描述 | 路径 |
|------|------|------|
| `BusinessException` | 业务异常类 | `module-common/src/main/java/com/lonbon/cloud/common/exception/BusinessException.java` |
| `ParameterException` | 参数异常类 | `module-common/src/main/java/com/lonbon/cloud/common/exception/ParameterException.java` |
| `CommonAutoConfiguration` | 公共模块自动配置类 | `module-common/src/main/java/com/lonbon/cloud/common/config/CommonAutoConfiguration.java` |

### 配置文件

| 文件名 | 描述 | 路径 |
|--------|------|------|
| `org.springframework.boot.autoconfigure.AutoConfiguration.imports` | Spring Boot 自动配置文件 | `module-base/src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` |
| `org.springframework.boot.autoconfigure.AutoConfiguration.imports` | Spring Boot 自动配置文件 | `module-common/src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` |

## 总结

全局异常处理系统是 Spring Boot 应用的重要组成部分，通过统一的异常处理机制，可以提高系统的健壮性、可维护性和用户体验。本文档详细介绍了全局异常处理系统的设计和实现，包括模块化设计、分层异常体系、统一错误响应、清晰的错误码体系等方面。

通过使用本文档介绍的异常处理系统，开发人员可以更加专注于业务逻辑的实现，而无需关心异常的捕获和处理细节，从而提高开发效率和代码质量。同时，统一的错误响应格式和清晰的错误码体系，也为前端开发和 API 调用者提供了更好的使用体验。

## 迁移指南

### 从旧版本迁移

如果您的项目之前使用了旧版本的异常处理系统，需要进行以下迁移：

1. **引入 base 模块依赖**：在所有模块的 pom.xml 文件中，添加对 base 模块的依赖
2. **更新异常类**：将自定义异常类改为继承自 base 模块中的 `BaseBusinessException` 或 `BaseTechException`
3. **更新错误码**：使用 base 模块中的 `ErrorCode` 枚举，替换旧的错误码定义
4. **移除旧的异常处理器**：移除项目中的旧全局异常处理器，使用 base 模块中的 `GlobalExceptionHandler`
5. **更新响应格式**：使用 base 模块中的 `ErrorResponse` 类，替换旧的错误响应格式

### 最佳迁移实践

- **分步迁移**：先迁移基础模块，再迁移业务模块
- **保持兼容性**：在迁移过程中，保持 API 响应格式的兼容性
- **充分测试**：在迁移完成后，充分测试各种异常情况的处理
- **文档更新**：更新项目文档，反映异常处理系统的变化

通过以上迁移步骤，可以顺利将项目从旧版本的异常处理系统迁移到新版本，享受模块化设计带来的好处。